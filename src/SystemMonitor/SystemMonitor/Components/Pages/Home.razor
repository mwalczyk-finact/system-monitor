@page "/"
@using ApexCharts
@using SystemMonitor.Services
@using SystemMonitor.Components.Buttons
@using SystemMonitor.Components.Typo
@using SystemMonitor.Models
@using SystemMonitor.Components.Charts

@inject ISystemPerformanceService PerformanceService

<MudContainer Class="mb-4" Style="text-align: center; margin-top: 20px; overflow: visible;">
    <MudText Color="MudBlazor.Color.Primary" Typo="Typo.h3" Style="font-weight:bold; margin-bottom: 16px;">
        System Performance Monitor
    </MudText>

    <MudSelect T="int" Label="Update Frequency (seconds)" Value="@updateInterval" ValueChanged="OnUpdateIntervalChanged">
        <MudSelectItem Value="1">1 second</MudSelectItem>
        <MudSelectItem Value="5">5 seconds</MudSelectItem>
        <MudSelectItem Value="10">10 seconds</MudSelectItem>
    </MudSelect>

    <RoundedButton Color="MudBlazor.Color.Success" Icon="@Icons.Material.Filled.PlayCircle" OnClick="@StartMonitoring" Text="Start">  </RoundedButton>
    <RoundedButton Color="MudBlazor.Color.Warning" Icon="@Icons.Material.Filled.PauseCircle" OnClick="@PauseMonitoring" Text="Pause">  </RoundedButton>
    <RoundedButton Color="MudBlazor.Color.Error" Icon="@Icons.Material.Filled.RestartAlt" OnClick="@ResetCharts" Text="Reset">  </RoundedButton>

    <AverageUsageDisplay Label="Average CPU Usage" Data="cpuData" Unit="%" />
    <AverageUsageDisplay Label="Average Memory Usage" Data="memoryData" Unit="%" />
    <AverageUsageDisplay Label="Average GPU Usage" Data="gpuData" Unit="%" />

</MudContainer>

<MudGrid Class="mt-2" Gutter="true" Style="height: 100vh; padding: 0;">
    <!-- CPU Chart -->
    <MudItem xs="12" md="4">
        <MudCard Elevation="6" Style="height: 100%; padding: 16px; margin-bottom: 16px;">
            <MudCardContent>
                <UsageChart @ref="cpuUsageChart" Title="CPU Usage" Data="cpuData" Options="CpuChartOptions" />
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- Memory Chart -->
    <MudItem xs="12" md="4">
        <MudCard Elevation="6" Style="height: 100%; padding: 16px; margin-bottom: 16px;">
            <MudCardContent>
                <UsageChart @ref="memoryUsageChart" Title="Memory Usage" Data="memoryData" Options="MemoryChartOptions" />
            </MudCardContent>
        </MudCard>
    </MudItem>

    <!-- GPU Chart -->
    <MudItem xs="12" md="4">
        <MudCard Elevation="6" Style="height: 100%; padding: 16px; margin-bottom: 16px;">
            <MudCardContent>
                <UsageChart @ref="gpuUsageChart" Title="GPU Usage" Data="gpuData" Options="GpuChartOptions" />
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>


@code {
    private List<ChartDataPoint> cpuData = new List<ChartDataPoint>();
    private List<ChartDataPoint> memoryData = new List<ChartDataPoint>();
    private List<ChartDataPoint> gpuData = new List<ChartDataPoint>();
    private UsageChart cpuUsageChart = new();
    private UsageChart memoryUsageChart = new();
    private UsageChart gpuUsageChart = new();
    private System.Timers.Timer? timer = new();
    private bool isMonitoring = true;
    private ApexChartOptions<ChartDataPoint> CpuChartOptions { get; set; } = new();
    private ApexChartOptions<ChartDataPoint> GpuChartOptions { get; set; } = new();
    private ApexChartOptions<ChartDataPoint> MemoryChartOptions { get; set; } = new();
    private int updateInterval = 1;

    protected override void OnInitialized()
    {
        // Set up the timer to update every second
        timer = new System.Timers.Timer(TimeSpan.FromSeconds(updateInterval));
        timer.Elapsed += async (sender, e) => await UpdatePerformanceData();
        timer.AutoReset = true;
        timer.Enabled = true;
        CpuChartOptions = CreateChartOptions();
        MemoryChartOptions = CreateChartOptions();
        GpuChartOptions = CreateChartOptions();
    }

    private void PauseMonitoring() => isMonitoring = false;
    private void StartMonitoring() => isMonitoring = true;

    private void OnUpdateIntervalChanged(int newInterval)
    {
        updateInterval = newInterval;

        // Restart the timer with the new interval
        if (timer != null)
        {
            timer.Stop();
            timer.Interval = updateInterval * 1000;
            timer.Start();
        }
    }

    private ApexChartOptions<ChartDataPoint> CreateChartOptions()
    {
        return new ApexChartOptions<ChartDataPoint>
            {
                Chart = new Chart
                {
                    Background = "#f4f4f4", // Light gray background
                    Toolbar = new Toolbar
                    {
                        Show = true
                    },
                    Animations = new Animations
                    {
                        Enabled = true, 
                        Easing = Easing.Easeinout, 
                        Speed = 500, 
                        AnimateGradually = new AnimateGradually
                        {
                            Enabled = true,
                            Delay = 150 
                        },
                        DynamicAnimation = new DynamicAnimation
                        {
                            Enabled = true,
                            Speed = 350 
                        }
                    }
                },
                Stroke = new Stroke
                {
                    Curve = Curve.Smooth,
                    Width = 3
                },
                Fill = new Fill
                {
                    Type = FillType.Gradient, 
                    Gradient = new FillGradient
                    {
                        Shade = GradientShade.Light,
                        Type = GradientType.Vertical,
                        ShadeIntensity = 0.5,
                        OpacityFrom = 0.7,
                        OpacityTo = 0.3,
                    }
                },
                Yaxis = new List<YAxis>
                {
                    new YAxis
                    {
                        Labels = new YAxisLabels
                        {
                            Formatter = "function(val) { return val + '%'; }",
                            Style = new AxisLabelStyle
                            {
                                FontSize = "12px",
                                Colors = "#333"
                            }
                        }

                    }
                },
                Xaxis = new XAxis
                {
                    Labels = new XAxisLabels
                    {
                        Formatter = "function(value) { return new Date(value).toLocaleTimeString('en-US', { hour: '2-digit', minute:'2-digit', second:'2-digit' }); }",
                        Show = false,
                        Style = new AxisLabelStyle
                        {
                            FontSize = "12px",
                            Colors = "#333"
                        }
                    }
                },
                Tooltip = new Tooltip
                {
                    Enabled = true,
                    X = new TooltipX
                    {
                        Formatter = "function(value) { return new Date(value).toLocaleTimeString(); }"
                    }
                },
                Grid = new Grid
                {
                    BorderColor = "#e0e0e0", 
                    Row = new GridRow
                    {
                        Colors = new List<string> { "#f0f0f0", "#ffffff" }, 
                        Opacity = 0.5
                    }
                }
            };
    }

    private async Task UpdatePerformanceData()
    {

        if (!isMonitoring) return;

        double cpuUsage = PerformanceService.GetCpuUsage();
        double memoryUsage = PerformanceService.GetMemoryUsage();
        double gpuUsage = PerformanceService.GetGpuUsage();

        cpuData.Add(new ChartDataPoint { Time = DateTime.Now, Value = cpuUsage });
        memoryData.Add(new ChartDataPoint { Time = DateTime.Now, Value = memoryUsage });
        gpuData.Add(new ChartDataPoint { Time = DateTime.Now, Value = gpuUsage });

        // Limit the history to the last 100 data points
        if (cpuData.Count > 100) cpuData.RemoveAt(0);
        if (memoryData.Count > 100) memoryData.RemoveAt(0);
        if (gpuData.Count > 100) gpuData.RemoveAt(0);

        // Update the charts with the new data without redrawing
        await cpuUsageChart.UpdateChartAsync();
        await memoryUsageChart.UpdateChartAsync();
        await gpuUsageChart.UpdateChartAsync();
    }

    private void ResetCharts()
    {
        cpuData.Clear();
        memoryData.Clear();
        gpuData.Clear();
        StateHasChanged();
    }

    public void Dispose()
    {
        if (timer != null)
        {
            timer.Stop();
            timer.Dispose();
        }
    }
}
